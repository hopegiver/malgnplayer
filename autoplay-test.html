<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MalgnPlayer Autoplay Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .player {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .info-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }

        .info-panel h3 {
            margin-top: 0;
            color: #495057;
        }

        .info-item {
            margin: 8px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
            font-family: monospace;
            font-size: 13px;
        }

        .log-panel {
            background: #212529;
            color: #28a745;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }

        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }

        .test-scenarios {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .scenario {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }

        .scenario h4 {
            margin-top: 0;
            color: #495057;
        }

        .scenario button {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔊 MalgnPlayer Autoplay Test</h1>

        <div id="player1" class="player"></div>

        <div class="controls">
            <button onclick="play()">▶️ Play</button>
            <button onclick="pause()">⏸️ Pause</button>
            <button onclick="forcePlay()">🎯 Force Play</button>
            <button onclick="toggleMute()">🔇 Toggle Mute</button>
            <button onclick="getAutoplayStatus()">📊 Get Status</button>
            <button onclick="clearLog()">🗑️ Clear Log</button>
        </div>

        <div class="test-scenarios">
            <div class="scenario">
                <h4>Autoplay Enabled (Muted)</h4>
                <p>브라우저 정책에 따라 음소거 상태로 자동 재생</p>
                <button onclick="createPlayer({ autoplay: true, muted: true })">Create Player</button>
            </div>

            <div class="scenario">
                <h4>Autoplay Enabled (Unmuted)</h4>
                <p>음성 포함 자동 재생 시도 (대부분 차단됨)</p>
                <button onclick="createPlayer({ autoplay: true, muted: false })">Create Player</button>
            </div>

            <div class="scenario">
                <h4>Autoloop Mode</h4>
                <p>자동 반복 모드 (항상 음소거)</p>
                <button onclick="createPlayer({ autoloop: true, loopStartTime: 5, loopEndTime: 15 })">Create Player</button>
            </div>

            <div class="scenario">
                <h4>Manual Play Only</h4>
                <p>자동 재생 없음, 수동 재생만</p>
                <button onclick="createPlayer({ autoplay: false })">Create Player</button>
            </div>
        </div>

        <div class="info-panel">
            <h3>📊 Autoplay Status</h3>
            <div class="info-item">Blocked: <span id="blocked">Unknown</span></div>
            <div class="info-item">User Interacted: <span id="interacted">Unknown</span></div>
            <div class="info-item">Waiting for Interaction: <span id="waiting">Unknown</span></div>
            <div class="info-item">Video Muted: <span id="muted">Unknown</span></div>
            <div class="info-item">Player State: <span id="state">Unknown</span></div>
        </div>

        <div class="log-panel" id="log"></div>
    </div>

    <script type="module">
        import MalgnPlayer from './dist/malgnplayer.esm.js';

        let player;
        const testVideo = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus() {
            if (!player) return;

            const status = player.getAutoplayStatus();
            const state = player.getState();

            document.getElementById('blocked').textContent = status.blocked ? 'Yes' : 'No';
            document.getElementById('interacted').textContent = status.userInteracted ? 'Yes' : 'No';
            document.getElementById('waiting').textContent = status.waitingForInteraction ? 'Yes' : 'No';
            document.getElementById('muted').textContent = status.videoMuted ? 'Yes' : 'No';
            document.getElementById('state').textContent = state || 'Unknown';
        }

        // Global functions for buttons
        window.createPlayer = function(config) {
            if (player) {
                player.destroy();
            }

            const finalConfig = {
                file: testVideo,
                width: '100%',
                height: '400px',
                ...config
            };

            log(`Creating player with config: ${JSON.stringify(finalConfig)}`, 'info');

            player = new MalgnPlayer('player1', finalConfig);

            // Event listeners
            player.on('ready', () => {
                log('Player ready');
                updateStatus();
            });

            player.on('play', () => {
                log('Playback started');
                updateStatus();
            });

            player.on('pause', () => {
                log('Playback paused');
                updateStatus();
            });

            player.on('error', (event) => {
                log(`Error: ${event.message || 'Unknown error'}`, 'error');
                updateStatus();
            });

            player.on('autoplayBlocked', (event) => {
                log(`Autoplay blocked: ${event.message}`, 'warning');
                updateStatus();
            });

            log('Player created');
            setTimeout(updateStatus, 1000);
        };

        window.play = async function() {
            if (!player) {
                log('No player created', 'warning');
                return;
            }

            try {
                const result = await player.play();
                log(`Play result: ${result}`);
                updateStatus();
            } catch (error) {
                log(`Play failed: ${error.message}`, 'error');
            }
        };

        window.pause = function() {
            if (!player) {
                log('No player created', 'warning');
                return;
            }

            player.pause();
            log('Pause called');
            updateStatus();
        };

        window.forcePlay = async function() {
            if (!player) {
                log('No player created', 'warning');
                return;
            }

            try {
                const result = await player.forcePlay();
                log(`Force play result: ${result}`);
                updateStatus();
            } catch (error) {
                log(`Force play failed: ${error.message}`, 'error');
            }
        };

        window.toggleMute = function() {
            if (!player || !player.core.video) {
                log('No player created', 'warning');
                return;
            }

            const video = player.core.video;
            video.muted = !video.muted;
            log(`Video muted: ${video.muted}`);
            updateStatus();
        };

        window.getAutoplayStatus = function() {
            if (!player) {
                log('No player created', 'warning');
                return;
            }

            const status = player.getAutoplayStatus();
            log(`Autoplay Status: ${JSON.stringify(status)}`);
            updateStatus();
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        // Initialize with default player
        log('Autoplay test page loaded');
        log('Browser supports autoplay: ' + (navigator.getAutoplayPolicy ? 'Advanced detection available' : 'Basic detection only'));

        // Create default player
        createPlayer({ autoplay: true, muted: true });
    </script>
</body>
</html>